<!DOCTYPE html>
<html lang="ko">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN</title>
<script src="inc/common.js"></script>
</head>

<body style="opacity:0;">

    <div class="container" id="container">
        <div class="d-flex justify-content-between align-items-center mb-5 px-3">
            <div id="navigator">
            </div>
            <button class="btn btn-logout px-4" id="logoutBtn">Logout</button>
        </div>

        <div class="row g-4">
            <div class="col-md-3">
                <div class="glass-panel text-center">
                    <p class="text-uppercase small opacity-75">Total Visitors</p>
                    <h3 class="display-6 fw-bold" id="totalVisitors">1,240</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-panel text-center">
                    <p class="text-uppercase small opacity-75">New Inquiries</p>
                    <h3 class="display-6 fw-bold" id="mobileVisitors">12</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-panel text-center">
                    <p class="text-uppercase small opacity-75">Server Status</p>
                    <h3 class="display-6 fw-bold" id="pcVisitors">Stable</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-panel text-center">
                    <p class="text-uppercase small opacity-75">Server Status</p>
                    <h3 class="display-6 fw-bold" id="todayVisitors">Stable</h3>
                </div>
            </div>


            <div class="col-12 mt-4">
                <div class="glass-panel">
                    <div id="admin-table"></div>
                </div>
            </div>

        </div>
</div>
<script>
document.addEventListener('supabaseReady', async function (e) {
    const { sb, session } = e.detail;

    async function loadVisitorLogs() {
        try {
            const { data, error } = await sb
                .from('visitor_log')
                .select('*')
                .order('vl_visited_at', { ascending: false });

            if (error) throw error;

            const now = new Date();
            const todayInt = parseInt(
                now.getFullYear().toString() +
                (now.getMonth() + 1).toString().padStart(2, '0') +
                now.getDate().toString().padStart(2, '0')
            );

            console.log("data", data);

            const total = data.length;
            const mobile = data.filter(v => v.vl_device_type === 'mobile').length;
            const pc = data.filter(v => v.vl_device_type === 'pc').length;
            const today = data.filter(v => v.vl_date_int === todayInt).length;

            document.getElementById('totalVisitors').textContent = total;
            document.getElementById('mobileVisitors').textContent = mobile;
            document.getElementById('pcVisitors').textContent = pc;
            document.getElementById('todayVisitors').textContent = today;

            let rowPopupFormatter = function(e, row, onRendered){
                let data = row.getData(),
                container = document.createElement("div"),
                contents = "<strong style='font-size:1.2em;'>USER AGENT</strong>";
                contents += `<div>${data.vl_user_agent}</div>`;

                container.innerHTML = contents;

                return container;
            };

            //create header popup contents
            let headerPopupFormatter = function(e, column, onRendered){
                let container = document.createElement("div");

                let label = document.createElement("label");
                label.innerHTML = "Filter Column:";
                label.style.display = "block";
                label.style.fontSize = ".7em";

                let input = document.createElement("input");
                input.placeholder = "Filter Column...";
                input.value = column.getHeaderFilterValue() || "";

                input.addEventListener("keyup", (e) => {
                    column.setHeaderFilterValue(input.value);
                });

                container.appendChild(label);
                container.appendChild(input);

                return container;
            }

            //create dummy header filter to allow popup to filter
            let emptyHeaderFilter = function(){
                return document.createElement("div");;
            }


            // Tabulator ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            const table = new Tabulator("#admin-table", {
                data: data, // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞ÏÑú ÏÑ§Ï†ï
                layout: "fitColumns",
                placeholder: "Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.",
                rowClickPopup:rowPopupFormatter,
                rowHeight:40, 
                headerHeight: 40,
                rowFormatter: function(row) {
                    const rowData = row.getData();
                    if (rowData.vl_date_int === todayInt) {
                        row.getElement().classList.add("today-row");
                    }
                },
                columns: [
                    {
                        title: "Î∞©Î¨∏ ÏãúÍ∞Ñ",
                        field: "vl_visited_at",
                        width: 180,
                        headerHozAlign: "center",
                        hozAlign:"center",
                        formatter: function (cell) {
                            return formatDate(cell.getValue());
                        }
                    },
                    {
                        title: "IP",
                        field: "vl_ip",
                        width: 180,
                        headerHozAlign: "center",
                        hozAlign:"center",
                    },
                    {
                        title: "Íµ≠Í∞Ä",
                        field: "vl_country_code",
                        width: 100,
                        headerHozAlign: "center",    
                        formatter: function (cell) {
                            const flag = countryCodeToFlag(cell.getValue());
                            return `<div style="text-align:center; " title="${cell.getValue()}">${flag}</div>`;
                        }
                    },                            
                    {
                        title: "Î∏åÎùºÏö∞Ï†Ä Ï†ïÎ≥¥",
                        field: "vl_user_agent",
                        headerHozAlign: "center",
                        formatter: function (cell) {
                            const parsed = parseUserAgent(cell.getValue());
                            return `<span style="display: inline-block; width: 30px; text-align:center;">${parsed.device}</span> <strong>${parsed.browser}</strong> on ${parsed.os}
                        `;
                        },
                        widthGrow: true
                    },
                    {
                        title: "ÎîîÎ∞îÏù¥Ïä§",
                        field: "vl_device_type",
                        width: 100,
                        hozAlign:"center",
                        headerHozAlign: "center",
                        formatter: function (cell) {
                            const type = cell.getValue();
                            let icon = "";
                            if(type.toUpperCase() == "PC"){icon = "üñ•";} else {icon = "üì±";}
                            return `<span class="device-badge device-${type}">${icon}</span>`;
                        }
                    }

                ]
            });

            table.on("renderComplete", function () {
                twemoji.parse(document.body);
            });

            loadComplete();

        } catch (error) {
            console.error('Error loading visitor logs:', error);
        }
    }
    loadVisitorLogs();

});
</script>

</body>

</html>